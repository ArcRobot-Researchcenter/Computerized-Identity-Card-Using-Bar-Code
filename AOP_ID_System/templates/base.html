<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ title or app_name }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#f6f7fb}
    .brand{font-weight:800;color:#063d8a}
    .sub{color:#666}
    .card{border:none;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .navbtn{font-weight:600}
    .muted{color:#8a8a8a}
  </style>
</head>
<body class="p-3 p-md-4">
<nav class="navbar navbar-expand-lg bg-white rounded shadow-sm mb-4">
  <div class="container-fluid">
    <a class="navbar-brand brand" href="{{ url_for('home') }}">{{ school_name }}</a>
    <div class="d-none d-md-block">
      <span class="text-muted me-3">{{ school_address }}</span>
      <span class="fw-bold">COMPUTERIZED IDENTITY CARD USING BAR CODE</span>
    </div>
    <div class="ms-auto d-flex align-items-center gap-2">
      {% if session.get('user_id') %}
        <span class="muted">{{ session.get('role')|capitalize }}</span>
        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('logout') }}">Logout</a>
      {% endif %}
    </div>
  </div>
</nav>
<div class="container">{% block content %}{% endblock %}</div>
<script>
function isSecure(){ return location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1'; }
async function startCam(){
  const v=document.getElementById('cam'); if(!v) return;
  if(!isSecure()){ alert('Camera requires HTTPS or localhost/127.0.0.1 in Chrome. Please run locally or use HTTPS.'); return; }
  try{
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user', width:{ideal:1280}, height:{ideal:720}}, audio:false});
    v.srcObject = stream;
  }catch(e){
    alert('Camera error: ' + (e.message || e));
  }
}
function snapShot(){
  const v=document.getElementById('cam'); const c=document.getElementById('snap'); const i=document.getElementById('shot_data');
  if(!v||!c||!i){ alert('Camera not ready. Click Start Camera first.'); return; }
  if(!v.srcObject){ alert('Camera not started. Click Start Camera.'); return; }
  const maxW = 900, maxH = 900;
  let w=v.videoWidth||1280, h=v.videoHeight||720;
  const ratio = Math.min(maxW/w, maxH/h, 1.0);
  const W = Math.round(w*ratio), H = Math.round(h*ratio);
  c.width=W; c.height=H;
  const ctx=c.getContext('2d');
  ctx.fillStyle='white'; ctx.fillRect(0,0,W,H);
  ctx.drawImage(v,0,0,W,H);
  i.value=c.toDataURL('image/jpeg', 0.82);
  alert('Snapshot captured (compressed). Submit the form to upload.');
}
function initSig(){
  const c=document.getElementById('sigpad'); if(!c) return; const ctx=c.getContext('2d');
  ctx.fillStyle='white'; ctx.fillRect(0,0,c.width,c.height);
  ctx.strokeStyle='black';
  let drawing=false, p={x:0,y:0};
  function pos(e){ const r=c.getBoundingClientRect(); if(e.touches){return {x:e.touches[0].clientX-r.left, y:e.touches[0].clientY-r.top}} return {x:e.offsetX, y:e.offsetY}; }
  function down(e){ drawing=true; p=pos(e); e.preventDefault(); }
  function up(e){ drawing=false; e.preventDefault(); }
  function move(e){ if(!drawing) return; const q=pos(e); ctx.lineWidth=2; ctx.lineCap='round'; ctx.beginPath(); ctx.moveTo(p.x,p.y); ctx.lineTo(q.x,q.y); ctx.stroke(); p=q; e.preventDefault(); }
  c.addEventListener('mousedown', down); c.addEventListener('mouseup', up); c.addEventListener('mouseleave', up); c.addEventListener('mousemove', move);
  c.addEventListener('touchstart', down, {passive:false}); c.addEventListener('touchend', up, {passive:false}); c.addEventListener('touchcancel', up, {passive:false}); c.addEventListener('touchmove', move, {passive:false});
}
function saveSig(){
  const c=document.getElementById('sigpad'); const i=document.getElementById('sig_data');
  if(c&&i){
    const out=document.createElement('canvas'); out.width=c.width; out.height=c.height;
    const octx=out.getContext('2d'); octx.fillStyle='white'; octx.fillRect(0,0,out.width,out.height); octx.drawImage(c,0,0);
    i.value=out.toDataURL('image/png');
    alert('Signature captured. Submit the form.');
  }
}
function clearSig(){ const c=document.getElementById('sigpad'); if(c){ const ctx=c.getContext('2d'); ctx.fillStyle='white'; ctx.fillRect(0,0,c.width,c.height);} }
</script>
</body>
</html>
